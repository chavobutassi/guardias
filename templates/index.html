<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Gestor de Guardias 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-primary: #2563eb;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-dark: #1f2937;
            --color-light: #f3f4f6;
            --color-border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: var(--color-dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .version-badge {
            display: inline-block;
            background: var(--color-primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-dark);
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar h2 {
            color: var(--color-dark);
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-light);
        }

        .mes-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 2px solid var(--color-border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            text-align: left;
        }

        .mes-btn:hover {
            background: var(--color-light);
            border-color: var(--color-primary);
        }

        .mes-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Calendar View */
        .calendar-view {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-light);
        }

        .calendar-header h2 {
            color: var(--color-dark);
            font-size: 2rem;
        }

        .calendar-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--color-warning);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 120px;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .day-card.habil {
            border-color: #93c5fd;
            background: #eff6ff;
        }

        .day-card.vispera {
            border-color: #fcd34d;
            background: #fef3c7;
        }

        .day-card.feriado {
            border-color: #fca5a5;
            background: #fee2e2;
        }

        .day-card.asignado {
            border-width: 3px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-dark);
        }

        .day-type {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .day-type.habil {
            background: #3b82f6;
            color: white;
        }

        .day-type.vispera {
            background: #f59e0b;
            color: white;
        }

        .day-type.feriado {
            background: #ef4444;
            color: white;
        }

        .day-weekday {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .day-persona {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-dark);
            padding: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 6px;
            margin-top: 8px;
        }

        .day-persona.conflicto {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .day-vacio {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-light);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--color-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .close-btn:hover {
            color: var(--color-danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-dark);
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--color-success);
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--color-danger);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--color-warning);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--color-info);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 4px solid var(--color-light);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Personas Management */
        .personas-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--color-light);
        }

        .persona-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--color-light);
        }

        .persona-item.activo {
            background: #d1fae5;
        }

        .persona-item.inactivo {
            background: #fee2e2;
            opacity: 0.7;
        }

        .persona-status {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .persona-status.activo {
            background: var(--color-success);
            color: white;
        }

        .persona-status.inactivo {
            background: var(--color-danger);
            color: white;
        }

        /* Sugerencia Badge */
        .sugerencia-badge {
            background: #dcfce7;
            color: #166534;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }

        /* User Selector Slider */
        .user-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .user-selector h3 {
            color: var(--color-dark);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .user-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-card {
            padding: 12px 15px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-card:hover {
            border-color: var(--color-primary);
            background: #eff6ff;
        }

        .user-card.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .user-card.inactive {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        .user-card-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-card-stats {
            font-size: 0.75rem;
            display: flex;
            gap: 8px;
        }

        .stat-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .user-card.selected .stat-badge {
            background: rgba(255,255,255,0.3);
        }

        .sugerencia-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            background: #fef3c7;
            color: #92400e;
            margin-top: 4px;
            font-weight: 500;
            border: 1px solid #fbbf24;
        }

        .sugerencia-badge.sugerencia-ok {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        /* Slider de Cuotas Sugeridas */
        .cuotas-slider {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            overflow-y: auto;
        }

        .cuotas-slider.active {
            right: 0;
        }

        .cuotas-slider-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1999;
        }

        .cuotas-slider-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .cuotas-slider-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .cuotas-slider-header h3 {
            margin: 0 0 8px 0;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .cuotas-slider-header p {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .cuotas-slider-header .close-slider {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .cuotas-slider-header .close-slider:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .cuotas-slider-content {
            padding: 25px;
        }

        .cuotas-resumen {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .cuotas-resumen h4 {
            margin: 0 0 15px 0;
            color: #1e293b;
            font-size: 1.05rem;
            font-weight: 700;
        }

        .cuotas-resumen-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .cuotas-resumen-item:last-child {
            border-bottom: none;
        }

        .cuotas-resumen-item span:first-child {
            color: #64748b;
        }

        .cuotas-resumen-item span:last-child {
            font-weight: 700;
            color: #1e293b;
        }

        .cuota-persona-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 14px;
            transition: all 0.2s;
        }

        .cuota-persona-card:hover {
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .cuota-persona-card.necesita-mas {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .cuota-persona-card.completo {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .cuota-persona-nombre {
            font-weight: 700;
            font-size: 1.05rem;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cuota-persona-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .cuota-stat {
            font-size: 0.85rem;
            color: #64748b;
            background: rgba(255,255,255,0.7);
            padding: 6px 10px;
            border-radius: 6px;
        }

        .cuota-stat strong {
            color: #1e293b;
            font-size: 1.1em;
        }

        .cuota-estado {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .cuota-estado.ok {
            background: #d1fae5;
            color: #065f46;
        }

        .cuota-estado.necesita {
            background: #fef3c7;
            color: #92400e;
        }

        .cuota-desglose {
            margin-top: 12px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #475569;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stats-summary {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .stats-summary.show {
            display: block;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            font-weight: 600;
            color: #6b7280;
        }

        .stats-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-dark);
        }

        /* Auto-assign mode */
        .day-card.auto-assign-mode {
            cursor: pointer;
        }

        .day-card.auto-assign-mode:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .day-card.can-assign {
            border-color: var(--color-success);
            border-width: 3px;
        }

        .day-card.cannot-assign {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .assign-indicator {
            background: var(--color-success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-primary));
            transition: width 0.3s;
        }

        /* Tablas de C√≥mputo */
        .computo-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .computo-table thead {
            background: var(--color-dark);
            color: white;
        }

        .computo-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #374151;
        }

        .computo-table td {
            padding: 10px 8px;
            border: 1px solid var(--color-border);
        }

        .computo-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .computo-table tbody tr:hover {
            background: #eff6ff;
        }

        .computo-table .text-center {
            text-align: center;
        }

        .computo-table .text-right {
            text-align: right;
        }

        .computo-table .total-row {
            background: #fef3c7 !important;
            font-weight: 700;
            border-top: 3px solid #f59e0b;
        }

        .computo-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .badge-habil {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-vispera {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-feriado {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-total {
            background: #f3f4f6;
            color: #1f2937;
            font-size: 1rem;
        }

        .badge-puntos {
            background: #e0e7ff;
            color: #3730a3;
            font-size: 0.95rem;
        }

        .computo-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .summary-card h4 {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-dark);
        }

        .summary-card .subtitle {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 5px;
        }

        .ranking-position {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .ranking-1 {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .ranking-2 {
            background: #e0e7ff;
            color: #3730a3;
        }

        .ranking-3 {
            background: #fee2e2;
            color: #991b1b;
        }

        .mes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .mes-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: transform 0.2s;
        }

        .mes-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .mes-card h5 {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .mes-card .dias {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìÖ Gestor de Guardias 2026</h1>
            <p>Sistema Inteligente de Gesti√≥n de Guardias</p>
            <span class="version-badge">v4.0 - Con Generador Integrado</span>
        </div>

        <!-- Alert Box -->
        <div id="alertBox" class="alert"></div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üìä</div>
                <h3>Total D√≠as</h3>
                <div class="value" id="statTotalDias">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">‚úÖ</div>
                <h3>Asignados</h3>
                <div class="value" id="statAsignados">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">‚è≥</div>
                <h3>Pendientes</h3>
                <div class="value" id="statPendientes">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">üë•</div>
                <h3>Personas Activas</h3>
                <div class="value" id="statPersonasActivas">-</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2>üìÜ Meses</h2>
                <div id="mesesList"></div>

                <div class="personas-section">
                    <h2>üë• Personas</h2>
                    <div id="personasList"></div>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="calendar-view">
                <div class="calendar-header">
                    <h2 id="mesActual">Selecciona un mes</h2>
                    <div class="calendar-controls">
                        <button class="btn btn-primary" onclick="mostrarComputoMensual()" id="btnComputoMensual" style="display: none;">
                            üìä C√≥mputo Mensual
                        </button>
                        <button class="btn btn-warning" onclick="mostrarComputoAnual()">
                            üìà C√≥mputo Anual
                        </button>
                        <button class="btn btn-danger" onclick="resetearMes()" id="btnResetearMes" style="display: none;">
                            üóëÔ∏è Resetear Mes
                        </button>
                        <button class="btn btn-success" onclick="descargarExcel()">
                            üì• Descargar Excel
                        </button>
                        <button class="btn btn-primary" onclick="mostrarGestionPersonas()">
                            ‚öôÔ∏è Gestionar Personas
                        </button>
                    </div>
                </div>

                <!-- User Selector -->
                <div class="user-selector" id="userSelector" style="display: none;">
                    <h3>üë§ Cuotas Mensuales - <span id="cuotasMesNombre"></span></h3>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 15px;">
                        Estas son las cuotas sugeridas para este mes. Asigna manualmente los d√≠as seg√∫n estas cantidades.
                    </p>
                    <div class="user-selector-grid" id="userSelectorGrid"></div>
                    
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="calcularCuotas()" id="btnCalcularCuotas">
                            üßÆ Calcular Cuotas del Mes
                        </button>
                        <button class="btn btn-success" onclick="distribucionBalanceada()" id="btnDistribuirPendientes">
                            ‚öñÔ∏è Distribuir D√≠as Pendientes
                        </button>
                    </div>

                    <div class="stats-summary" id="userStats">
                        <h4 style="margin-bottom: 10px; color: var(--color-dark);">üìä Tus asignaciones en <span id="statsUserName"></span></h4>
                        <div class="stats-row">
                            <span class="stats-label">Total de d√≠as:</span>
                            <span class="stats-value" id="statsTotal">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">D√≠as h√°biles:</span>
                            <span class="stats-value" id="statsHabil" style="color: #3b82f6;">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">V√≠speras:</span>
                            <span class="stats-value" id="statsVispera" style="color: #f59e0b;">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Feriados:</span>
                            <span class="stats-value" id="statsFeriado" style="color: #ef4444;">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Este mes:</span>
                            <span class="stats-value" id="statsMesActual">0</span>
                        </div>
                    </div>
                </div>

                <div class="info-box" id="mesInfo" style="display: none;">
                    <p><strong>Total d√≠as:</strong> <span id="infoTotalDias">-</span></p>
                    <p><strong>Asignados:</strong> <span id="infoAsignados">-</span> | <strong>Pendientes:</strong> <span id="infoPendientes">-</span></p>
                    <p><strong>Conflictos:</strong> <span id="infoConflictos">-</span></p>
                </div>

                <div id="calendarGrid" class="calendar-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Selecciona un mes para comenzar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Guardia -->
    <div id="modalAsignar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Asignar Guardia</h3>
                <button class="close-btn" onclick="cerrarModal('modalAsignar')">&times;</button>
            </div>

            <div class="info-box">
                <p><strong>D√≠a:</strong> <span id="modalDia">-</span></p>
                <p><strong>Fecha:</strong> <span id="modalFecha">-</span></p>
                <p><strong>Tipo:</strong> <span id="modalTipo">-</span></p>
            </div>

            <div id="modalPermisoAviso" style="display:none; background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; padding:10px 14px; font-size:0.85rem; color:#1d4ed8; margin-bottom:12px;">
                üîí Este d√≠a ya est√° asignado a otra persona. Solo pod√©s modificar tus propias guardias.
            </div>

            <div class="form-group">
                <label>Persona Asignada</label>
                <select id="modalPersonaSelect"></select>
            </div>

            <div id="modalSugerencia" style="display: none;">
                <span class="sugerencia-badge">üí° Sugerencia: <span id="sugerenciaTexto"></span></span>
            </div>

            <div class="modal-actions">
                <button class="btn btn-danger" onclick="eliminarGuardia()" id="btnEliminar" style="display: none;">
                    üóëÔ∏è Eliminar
                </button>
                <button class="btn btn-success" onclick="guardarAsignacion()">
                    ‚úÖ Guardar
                </button>
                <button class="btn btn-primary" onclick="cerrarModal('modalAsignar')">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Gesti√≥n de Personas -->
    <div id="modalPersonas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gestionar Disponibilidad</h3>
                <button class="close-btn" onclick="cerrarModal('modalPersonas')">&times;</button>
            </div>

            <div id="gestionPersonasList"></div>
        </div>
    </div>

    <!-- Modal C√≥mputo Mensual -->
    <div id="modalComputoMensual" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>üìä C√≥mputo Mensual - <span id="computoMesNombre"></span></h3>
                <button class="close-btn" onclick="cerrarModal('modalComputoMensual')">&times;</button>
            </div>

            <div id="computoMensualContent"></div>
        </div>
    </div>

    <!-- Modal C√≥mputo Anual -->
    <div id="modalComputoAnual" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3>üìà C√≥mputo Anual 2026 - Resumen Completo</h3>
                <button class="close-btn" onclick="cerrarModal('modalComputoAnual')">&times;</button>
            </div>

            <div id="computoAnualContent"></div>
        </div>
    </div>

    <!-- Overlay para el slider -->
    <div class="cuotas-slider-overlay" id="cuotasSliderOverlay" onclick="cerrarSliderCuotas()"></div>

    <!-- Slider de Cuotas Sugeridas -->
    <div class="cuotas-slider" id="cuotasSlider">
        <div class="cuotas-slider-header">
            <button class="close-slider" onclick="cerrarSliderCuotas()" title="Cerrar">√ó</button>
            <h3>üìä Cuotas Sugeridas</h3>
            <p id="cuotasMesNombre"></p>
        </div>
        <div class="cuotas-slider-content">
            <div class="cuotas-resumen" id="cuotasResumen">
                <!-- Se llena din√°micamente -->
            </div>
            <div id="cuotasPersonas">
                <!-- Se llena din√°micamente con las tarjetas de personas -->
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="modalLogin" style="
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 9999; display:flex; align-items:center; justify-content:center;
        flex-direction: column;
    ">
        <div style="background:white; border-radius:20px; padding:40px; width:100%; max-width:420px; box-shadow:0 25px 50px rgba(0,0,0,0.3);">
            <div style="text-align:center; margin-bottom:30px;">
                <div style="font-size:3rem; margin-bottom:10px;">üõ°Ô∏è</div>
                <h2 style="color:#1f2937; margin-bottom:5px;">Gestor de Guardias 2026</h2>
                <p id="loginSubtitulo" style="color:#6b7280; font-size:0.9rem;">Ingres√° con tu n√∫mero de usuario</p>
            </div>

            <!-- Formulario Login -->
            <div id="formLogin">
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">N√∫mero de usuario</label>
                    <input id="loginId" type="text" placeholder="Tu n√∫mero personal"
                        style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem; outline:none; transition:border 0.2s;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"
                        onkeydown="if(event.key==='Enter') document.getElementById('loginClave').focus()">
                </div>
                <div style="margin-bottom:24px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">Contrase√±a</label>
                    <input id="loginClave" type="password" placeholder="Tu contrase√±a"
                        style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem; outline:none; transition:border 0.2s;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"
                        onkeydown="if(event.key==='Enter') doLogin()">
                </div>
                <button onclick="doLogin()" style="
                    width:100%; padding:14px; background:linear-gradient(135deg,#6366f1,#8b5cf6);
                    color:white; border:none; border-radius:10px; font-size:1rem; font-weight:600;
                    cursor:pointer; transition:opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Ingresar ‚Üí
                </button>
                <button onclick="mostrarFormConfigurar()" style="
                    width:100%; padding:10px; background:none; border:none;
                    color:#6366f1; font-size:0.9rem; cursor:pointer; margin-top:12px;">
                    Primera vez ‚Äî Crear cuenta
                </button>
                <div id="loginError" style="display:none; background:#fef2f2; border:1px solid #fca5a5; color:#dc2626; padding:10px 14px; border-radius:8px; font-size:0.9rem; margin-top:12px;"></div>
            </div>

            <!-- Formulario Configurar (primera vez) -->
            <div id="formConfigurar" style="display:none;">
                <div style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; padding:12px; margin-bottom:20px; font-size:0.85rem; color:#1d4ed8;">
                    ‚ìò Eleg√≠ un n√∫mero de usuario (el que quieras), seleccion√° tu nombre y cre√° tu contrase√±a.
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">N√∫mero de usuario (eleg√≠ uno)</label>
                    <input id="confId" type="text" placeholder="Ej: 42, 007, 1234..."
                        style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem; outline:none;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">Tu nombre</label>
                    <select id="confNombre" style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:0.95rem; outline:none; background:white;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'">
                        <option value="">-- Seleccion√° tu nombre --</option>
                        <option>TNIM BUTASSI</option>
                        <option>TNAU BARRIOS</option>
                        <option>TN MACHUCA</option>
                        <option>TF ZALAZAR</option>
                        <option>TF ONETO CAJAL</option>
                        <option>TFCO LEDESMA</option>
                        <option>TFIM GONZALEZ</option>
                        <option>TFIM RACEDO BRITO</option>
                        <option>TCCO PALMA</option>
                        <option>TC LEDESMA</option>
                        <option>GUIM DIAZ</option>
                        <option>GUIM TORRES</option>
                        <option>GUCO BENITEZ</option>
                    </select>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">Contrase√±a</label>
                    <input id="confClave" type="password" placeholder="M√≠nimo 4 caracteres"
                        style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem; outline:none;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div style="margin-bottom:24px;">
                    <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px; font-size:0.9rem;">Confirmar contrase√±a</label>
                    <input id="confClaveConf" type="password" placeholder="Repet√≠ la contrase√±a"
                        style="width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem; outline:none;"
                        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"
                        onkeydown="if(event.key==='Enter') doConfigurar()">
                </div>
                <button onclick="doConfigurar()" style="
                    width:100%; padding:14px; background:linear-gradient(135deg,#059669,#10b981);
                    color:white; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer;">
                    ‚úÖ Crear cuenta
                </button>
                <button onclick="mostrarFormLogin()" style="
                    width:100%; padding:10px; background:none; border:none;
                    color:#6b7280; font-size:0.9rem; cursor:pointer; margin-top:12px;">
                    ‚Üê Volver al login
                </button>
                <div id="confError" style="display:none; background:#fef2f2; border:1px solid #fca5a5; color:#dc2626; padding:10px 14px; border-radius:8px; font-size:0.9rem; margin-top:12px;"></div>
            </div>
        </div>
    </div>

    <!-- Barra de usuario (se muestra cuando est√° logueado) -->
    <div id="barraUsuario" style="
        display:none; position:fixed; top:15px; right:20px; z-index:1000;
        background:white; border-radius:12px; padding:10px 16px;
        box-shadow:0 4px 15px rgba(0,0,0,0.15);
        align-items:center; gap:12px; font-size:0.9rem;
    ">
        <span>üë§ <strong id="barraUsuarioNombre"></strong></span>
        <button onclick="doLogout()" style="
            background:#fee2e2; color:#dc2626; border:none; border-radius:6px;
            padding:5px 10px; font-size:0.8rem; cursor:pointer; font-weight:600;">
            Salir
        </button>
    </div>

    <script>
        // Variables globales
        let mesActual = null;
        let diasMes = {};
        let personasDisponibilidad = {};
        let diaSeleccionado = null;
        let usuarioSeleccionado = null;
        let estadisticasUsuarios = {};

        // Estado de sesi√≥n del usuario
        let sesionUsuario = null;

        // ============================================================================
        // AUTENTICACI√ìN
        // ============================================================================

        async function verificarSesion() {
            try {
                const resp = await fetch('/api/auth/estado', {credentials:'include'});
                const data = await resp.json();
                if (data.autenticado) {
                    sesionUsuario = { id: data.usuario_id, nombre: data.nombre };
                    mostrarAppConUsuario();
                    return true;
                }
            } catch(e) {}
            return false;
        }

        function mostrarAppConUsuario() {
            document.getElementById('modalLogin').style.display = 'none';
            const barra = document.getElementById('barraUsuario');
            barra.style.display = 'flex';
            document.getElementById('barraUsuarioNombre').textContent = sesionUsuario.nombre;
        }

        function mostrarFormLogin() {
            document.getElementById('formLogin').style.display = 'block';
            document.getElementById('formConfigurar').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
        }

        function mostrarFormConfigurar() {
            document.getElementById('formLogin').style.display = 'none';
            document.getElementById('formConfigurar').style.display = 'block';
            document.getElementById('confError').style.display = 'none';
            // Copiar el n√∫mero escrito en el login, si lo hab√≠a
            const idLogin = document.getElementById('loginId').value;
            if (idLogin) document.getElementById('confId').value = idLogin;
            setTimeout(() => document.getElementById('confId').focus(), 50);
        }

        async function doLogin() {
            const usuario_id = (document.getElementById('loginId').value || '').trim();
            const clave = (document.getElementById('loginClave').value || '').trim();
            const errEl = document.getElementById('loginError');
            errEl.style.display = 'none';

            if (!usuario_id) {
                errEl.textContent = 'Ingres√° tu n√∫mero de usuario';
                errEl.style.display = 'block';
                document.getElementById('loginId').focus(); return;
            }
            if (!clave) {
                errEl.textContent = 'Ingres√° tu contrase√±a';
                errEl.style.display = 'block';
                document.getElementById('loginClave').focus(); return;
            }

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST', credentials: 'include',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({usuario_id, clave})
                });
                const data = await resp.json();

                if (resp.ok) {
                    sesionUsuario = { id: data.usuario_id, nombre: data.nombre };
                    mostrarAppConUsuario();
                    await init();
                } else if (data.error === 'cuenta_no_configurada') {
                    document.getElementById('confId').value = usuario_id;
                    mostrarFormConfigurar();
                } else {
                    errEl.textContent = data.error || 'Error al ingresar';
                    errEl.style.display = 'block';
                }
            } catch(e) {
                errEl.textContent = 'Error de conexi√≥n con el servidor';
                errEl.style.display = 'block';
            }
        }

        async function doConfigurar() {
            const idEl = document.getElementById('confId');
            const nomEl = document.getElementById('confNombre');
            const claveEl = document.getElementById('confClave');
            const confEl = document.getElementById('confClaveConf');
            const errEl = document.getElementById('confError');
            errEl.style.display = 'none';

            const usuario_id = (idEl.value || '').trim();
            const nombre = (nomEl.value || '').trim();
            const clave = (claveEl.value || '').trim();
            const conf = (confEl.value || '').trim();

            if (!usuario_id) {
                errEl.textContent = 'Ingres√° un n√∫mero de usuario'; errEl.style.display = 'block'; idEl.focus(); return;
            }
            if (!nombre) {
                errEl.textContent = 'Seleccion√° tu nombre de la lista'; errEl.style.display = 'block'; nomEl.focus(); return;
            }
            if (!clave) {
                errEl.textContent = 'Ingres√° una contrase√±a'; errEl.style.display = 'block'; claveEl.focus(); return;
            }
            if (clave.length < 4) {
                errEl.textContent = 'La contrase√±a debe tener al menos 4 caracteres'; errEl.style.display = 'block'; claveEl.focus(); return;
            }
            if (clave !== conf) {
                errEl.textContent = 'Las contrase√±as no coinciden'; errEl.style.display = 'block'; confEl.focus(); return;
            }

            try {
                const resp = await fetch('/api/auth/configurar', {
                    method: 'POST', credentials: 'include',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({usuario_id, nombre, clave, clave_confirm: conf})
                });
                const data = await resp.json();

                if (resp.ok) {
                    sesionUsuario = { id: data.usuario_id, nombre: data.nombre };
                    mostrarAppConUsuario();
                    await init();
                } else {
                    errEl.textContent = data.error || 'Error al crear cuenta';
                    errEl.style.display = 'block';
                }
            } catch(e) {
                errEl.textContent = 'Error de conexi√≥n con el servidor';
                errEl.style.display = 'block';
            }
        }

        async function doLogout() {
            await fetch('/api/auth/logout', {method:'POST', credentials:'include'});
            sesionUsuario = null;
            document.getElementById('barraUsuario').style.display = 'none';
            document.getElementById('modalLogin').style.display = 'flex';
            document.getElementById('loginId').value = '';
            document.getElementById('loginClave').value = '';
            mostrarFormLogin();
        }

        // ============================================================================
        // INICIALIZACI√ìN
        // ============================================================================

        // Inicializar aplicaci√≥n
        async function init() {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            
            try {
                console.log('1Ô∏è‚É£ Cargando informaci√≥n general...');
                await cargarInfo();
                
                console.log('2Ô∏è‚É£ Cargando meses disponibles...');
                await cargarMeses();
                
                console.log('3Ô∏è‚É£ Cargando personas...');
                await cargarPersonas();
                
                console.log('4Ô∏è‚É£ Cargando disponibilidad...');
                await cargarDisponibilidad();
                
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
            } catch (error) {
                console.error('‚ùå Error al inicializar:', error);
                mostrarAlerta('Error al inicializar la aplicaci√≥n: ' + error.message, 'error');
            }
        }

        // Cargar informaci√≥n general
        async function cargarInfo() {
            try {
                console.log('   üì° Llamando a /api/info...');
                const response = await fetch('/api/info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('   ‚úì Datos recibidos de /api/info:', data);
                
                // Actualizar estad√≠sticas del dashboard
                const elemPersonas = document.getElementById('statPersonasActivas');
                if (elemPersonas) {
                    elemPersonas.textContent = data.total_activas || '0';
                    console.log('   ‚úì Personas activas actualizadas:', data.total_activas);
                } else {
                    console.error('   ‚ùå Elemento #statPersonasActivas no encontrado');
                }
                
                // Cargar estad√≠sticas generales
                console.log('   üì° Cargando estad√≠sticas generales...');
                await cargarEstadisticasGenerales();
            } catch (error) {
                console.error('   ‚ùå Error cargando info:', error);
                // Establecer valores por defecto
                const elemPersonas = document.getElementById('statPersonasActivas');
                if (elemPersonas) elemPersonas.textContent = '-';
                throw error;
            }
        }
        
        // Cargar estad√≠sticas generales del a√±o
        async function cargarEstadisticasGenerales() {
            try {
                console.log('      üì° Llamando a /api/reporte/anual...');
                const response = await fetch('/api/reporte/anual');
                
                if (!response.ok) {
                    console.warn('      ‚ö†Ô∏è /api/reporte/anual fall√≥:', response.status);
                    // Usar valores por defecto
                    setEstadisticasPorDefecto();
                    return;
                }
                
                const data = await response.json();
                console.log('      ‚úì Datos recibidos de /api/reporte/anual:', data);
                
                if (data.totales) {
                    const elemTotal = document.getElementById('statTotalDias');
                    const elemAsignados = document.getElementById('statAsignados');
                    const elemPendientes = document.getElementById('statPendientes');
                    
                    if (elemTotal) {
                        elemTotal.textContent = data.totales.dias_totales || '0';
                        console.log('      ‚úì Total d√≠as:', data.totales.dias_totales);
                    }
                    if (elemAsignados) {
                        elemAsignados.textContent = data.totales.dias_asignados || '0';
                        console.log('      ‚úì Asignados:', data.totales.dias_asignados);
                    }
                    if (elemPendientes) {
                        elemPendientes.textContent = data.totales.dias_pendientes || '0';
                        console.log('      ‚úì Pendientes:', data.totales.dias_pendientes);
                    }
                } else {
                    console.warn('      ‚ö†Ô∏è No hay datos.totales, usando valores por defecto');
                    setEstadisticasPorDefecto();
                }
            } catch (error) {
                console.error('      ‚ùå Error cargando estad√≠sticas generales:', error);
                setEstadisticasPorDefecto();
            }
        }
        
        // Establecer valores por defecto
        function setEstadisticasPorDefecto() {
            const elemTotal = document.getElementById('statTotalDias');
            const elemAsignados = document.getElementById('statAsignados');
            const elemPendientes = document.getElementById('statPendientes');
            
            if (elemTotal) elemTotal.textContent = '365';
            if (elemAsignados) elemAsignados.textContent = '0';
            if (elemPendientes) elemPendientes.textContent = '365';
            
            console.log('      ‚ÑπÔ∏è Valores por defecto establecidos');
        }

        // Cargar meses disponibles
        async function cargarMeses() {
            try {
                const response = await fetch('/api/calendario');
                const data = await response.json();
                
                const mesesList = document.getElementById('mesesList');
                mesesList.innerHTML = '';
                
                data.meses.forEach(mes => {
                    const btn = document.createElement('button');
                    btn.className = 'mes-btn';
                    btn.textContent = mes;
                    btn.onclick = () => cargarMes(mes);
                    mesesList.appendChild(btn);
                });
            } catch (error) {
                console.error('Error cargando meses:', error);
                mostrarAlerta('Error al cargar los meses', 'error');
            }
        }

        // Cargar datos de un mes
        async function cargarMes(mes) {
            try {
                mesActual = mes;
                
                // Actualizar botones
                document.querySelectorAll('.mes-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === mes);
                });
                
                document.getElementById('mesActual').textContent = mes + ' 2026';
                
                // Mostrar botones del mes
                document.getElementById('btnComputoMensual').style.display = 'inline-block';
                document.getElementById('btnResetearMes').style.display = 'inline-block';
                
                // Mostrar selector de usuario
                document.getElementById('userSelector').style.display = 'block';
                await cargarSelectorUsuarios();
                
                // Mostrar loading
                document.getElementById('calendarGrid').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando ${mes}...</p>
                    </div>
                `;
                
                const response = await fetch(`/api/mes/${mes}`);
                const data = await response.json();
                
                diasMes = data.dias;
                
                // Actualizar estad√≠sticas
                document.getElementById('statTotalDias').textContent = data.estadisticas.total;
                document.getElementById('statAsignados').textContent = data.estadisticas.asignados;
                document.getElementById('statPendientes').textContent = data.estadisticas.pendientes;
                
                // Actualizar info del mes
                document.getElementById('mesInfo').style.display = 'block';
                document.getElementById('infoTotalDias').textContent = data.estadisticas.total;
                document.getElementById('infoAsignados').textContent = data.estadisticas.asignados;
                document.getElementById('infoPendientes').textContent = data.estadisticas.pendientes;
                document.getElementById('infoConflictos').textContent = data.estadisticas.conflictos;
                
                renderizarCalendario(data.dias);
                
                // Actualizar estad√≠sticas del usuario si hay uno seleccionado
                if (usuarioSeleccionado) {
                    await cargarEstadisticasUsuario(usuarioSeleccionado);
                }
            } catch (error) {
                console.error('Error cargando mes:', error);
                mostrarAlerta('Error al cargar el mes: ' + error.message, 'error');
            }
        }

        // Renderizar calendario
        function renderizarCalendario(dias) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const diasOrdenados = Object.keys(dias).sort((a, b) => a - b);
            
            diasOrdenados.forEach(dia => {
                const info = dias[dia];
                const card = document.createElement('div');
                card.className = `day-card ${info.tipo}`;
                
                if (info.persona) {
                    card.classList.add('asignado');
                }
                
                let conflictoClass = '';
                let conflictoWarning = '';
                if (info.persona && !info.disponible) {
                    conflictoClass = 'conflicto';
                    conflictoWarning = '<div style="color: #dc2626; font-size: 0.75rem; margin-top: 5px;">‚ö†Ô∏è No disponible</div>';
                }
                
                card.innerHTML = `
                    <div class="day-header">
                        <div class="day-number">${dia}</div>
                        <span class="day-type ${info.tipo}">${info.tipo}</span>
                    </div>
                    <div class="day-weekday">${info.dia_semana}</div>
                    ${info.persona 
                        ? `<div class="day-persona ${conflictoClass}">${info.persona}${conflictoWarning}</div>` 
                        : '<div class="day-vacio">Sin asignar</div>'
                    }
                `;
                
                // Event handler
                card.onclick = () => abrirModalAsignar(dia);
                
                grid.appendChild(card);
            });
        }

        // Abrir modal de asignaci√≥n
        async function abrirModalAsignar(dia) {
            diaSeleccionado = dia;
            const info = diasMes[dia];
            
            document.getElementById('modalDia').textContent = dia;
            document.getElementById('modalFecha').textContent = info.fecha;
            document.getElementById('modalTipo').textContent = info.tipo.toUpperCase();
            
            // Cargar select de personas
            const select = document.getElementById('modalPersonaSelect');
            select.innerHTML = '<option value="">-- Seleccionar persona --</option>';
            
            // Obtener personas activas para esta fecha
            const respActivas = await fetch(`/api/personas/activas?fecha=${info.fecha}`);
            const dataActivas = await respActivas.json();
            
            // CONTROL DE PERMISOS: solo se puede elegir a s√≠ mismo
            const miNombre = sesionUsuario ? sesionUsuario.nombre : null;

            dataActivas.personas.forEach(p => {
                // Solo agregar la opci√≥n del usuario logueado
                if (miNombre && p.nombre !== miNombre) return;
                const option = document.createElement('option');
                option.value = p.nombre;
                option.textContent = p.nombre;
                if (p.nombre === info.persona) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Si el d√≠a ya tiene asignada otra persona, mostrar como info
            if (info.persona && info.persona !== miNombre) {
                select.innerHTML = `<option value="${info.persona}" disabled selected>${info.persona} (asignado)</option>`;
                select.disabled = true;
                document.getElementById('modalPermisoAviso').style.display = 'block';
                document.querySelector('#modalAsignar .btn-success').disabled = true;
            } else {
                select.disabled = false;
                document.getElementById('modalPermisoAviso').style.display = 'none';
                document.querySelector('#modalAsignar .btn-success').disabled = false;
            }
            
            // Mostrar bot√≥n eliminar solo si la guardia es del usuario actual
            const esPropia = info.persona && info.persona === miNombre;
            document.getElementById('btnEliminar').style.display = esPropia ? 'block' : 'none';
            
            // Obtener sugerencia
            try {
                const respSugerencia = await fetch(`/api/sugerir/${mesActual}/${dia}`);
                const dataSugerencia = await respSugerencia.json();
                
                if (dataSugerencia.sugerencia) {
                    document.getElementById('sugerenciaTexto').textContent = dataSugerencia.sugerencia;
                    document.getElementById('modalSugerencia').style.display = 'block';
                } else {
                    document.getElementById('modalSugerencia').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('modalSugerencia').style.display = 'none';
            }
            
            document.getElementById('modalAsignar').classList.add('active');
        }

        // Guardar asignaci√≥n
        async function guardarAsignacion() {
            const persona = document.getElementById('modalPersonaSelect').value;
            
            if (!persona) {
                mostrarAlerta('Debes seleccionar una persona', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/asignar', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mes: mesActual,
                        dia: parseInt(diaSeleccionado),
                        persona: persona,
                        forzar: false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    mostrarAlerta(data.mensaje, 'success');
                    cerrarModal('modalAsignar');
                    await cargarMes(mesActual);  // Recargar el mes completo
                    
                    // Si hay usuario seleccionado, actualizar sus estad√≠sticas
                    if (usuarioSeleccionado) {
                        await cargarEstadisticasUsuario(usuarioSeleccionado);
                    }
                } else {
                    if (data.error === 'persona_no_disponible') {
                        if (confirm(`${data.mensaje}\n\n¬øDeseas asignar de todas formas?`)) {
                            // Reintentar con forzar = true
                            const response2 = await fetch('/api/asignar', {
                                method: 'POST',
                                credentials: 'include',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    mes: mesActual,
                                    dia: parseInt(diaSeleccionado),
                                    persona: persona,
                                    forzar: true
                                })
                            });
                            
                            const data2 = await response2.json();
                            if (response2.ok) {
                                mostrarAlerta(data2.mensaje, 'success');
                                cerrarModal('modalAsignar');
                                await cargarMes(mesActual);
                                
                                if (usuarioSeleccionado) {
                                    await cargarEstadisticasUsuario(usuarioSeleccionado);
                                }
                            } else {
                                mostrarAlerta('Error: ' + data2.error, 'error');
                            }
                        }
                    } else {
                        mostrarAlerta('Error: ' + (data.mensaje || data.error), 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al guardar la asignaci√≥n: ' + error.message, 'error');
            }
        }

        // Eliminar guardia
        async function eliminarGuardia() {
            if (!confirm('¬øEst√°s seguro de eliminar esta guardia?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/eliminar', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mes: mesActual,
                        dia: parseInt(diaSeleccionado)  // Asegurar que sea n√∫mero
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    mostrarAlerta(data.mensaje, 'success');
                    cerrarModal('modalAsignar');
                    
                    // Recargar mes y actualizar estad√≠sticas
                    await cargarMes(mesActual);
                    
                    // Si hay usuario seleccionado, actualizar sus estad√≠sticas
                    if (usuarioSeleccionado) {
                        await cargarEstadisticasUsuario(usuarioSeleccionado);
                    }
                    
                    // Actualizar selector de usuarios
                    await cargarSelectorUsuarios();
                } else {
                    mostrarAlerta('Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al eliminar la guardia: ' + error.message, 'error');
            }
        }

        // Cargar personas
        async function cargarPersonas() {
            try {
                const response = await fetch('/api/personas/activas');
                const data = await response.json();
                
                const lista = document.getElementById('personasList');
                lista.innerHTML = '';
                
                // Cargar todas las personas
                const respDisp = await fetch('/api/disponibilidad');
                const dataDisp = await respDisp.json();
                
                // Ordenar por orden de llenado
                const personasOrdenadas = Object.entries(dataDisp).sort((a, b) => (a[1].orden ?? 99) - (b[1].orden ?? 99));
                personasOrdenadas.forEach(([persona, info]) => {
                    const item = document.createElement('div');
                    item.className = `persona-item ${info.activo ? 'activo' : 'inactivo'}`;
                    item.innerHTML = `
                        <span style="font-size: 0.9rem; font-weight: 500;">
                            <span style="color:#9ca3af; font-weight:600; margin-right:4px;">#${info.orden ?? '?'}</span>${persona}
                            <span style="font-size:0.75rem; color:#9ca3af; margin-left:4px;">RINA ${info.rina ?? '-'}</span>
                        </span>
                        <span class="persona-status ${info.activo ? 'activo' : 'inactivo'}">
                            ${info.activo ? '‚úì Activo' : '‚úó Inactivo'}
                        </span>
                    `;
                    lista.appendChild(item);
                });
            } catch (error) {
                console.error('Error cargando personas:', error);
            }
        }

        // Cargar disponibilidad
        async function cargarDisponibilidad() {
            try {
                const response = await fetch('/api/disponibilidad');
                personasDisponibilidad = await response.json();
            } catch (error) {
                console.error('Error cargando disponibilidad:', error);
            }
        }

        // Mostrar gesti√≥n de personas
        async function mostrarGestionPersonas() {
            await cargarDisponibilidad();
            
            const lista = document.getElementById('gestionPersonasList');
            lista.innerHTML = '';
            
            Object.keys(personasDisponibilidad).forEach(persona => {
                const info = personasDisponibilidad[persona];
                const div = document.createElement('div');
                div.style.marginBottom = '20px';
                div.style.padding = '20px';
                div.style.background = info.activo ? '#f0fdf4' : '#fef2f2';
                div.style.borderRadius = '8px';
                div.style.border = `2px solid ${info.activo ? '#86efac' : '#fca5a5'}`;
                
                const activo = info.activo;
                const desde = info.desde || '';
                const hasta = info.hasta || '';
                const motivo = info.motivo || '';
                
                div.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--color-dark); display: flex; align-items: center; gap: 10px;">
                            <span>${persona}</span>
                            <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; background: ${activo ? '#22c55e' : '#ef4444'}; color: white;">
                                ${activo ? '‚úì ACTIVO' : '‚úó INACTIVO'}
                            </span>
                        </h4>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <!-- Estado -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="check_${persona}" ${activo ? 'checked' : ''} 
                                       onchange="togglePersonaActivo('${persona}', this.checked)"
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Persona Activa (Disponible para guardias)</span>
                            </label>
                        </div>
                        
                        <!-- Panel de Inactividad -->
                        <div id="panel_${persona}" style="display: ${activo ? 'none' : 'block'}; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <h5 style="margin: 0 0 12px 0; color: #dc2626; font-size: 0.95rem;">
                                üìÖ Per√≠odo de Inactividad
                            </h5>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #374151;">
                                        Desde:
                                    </label>
                                    <input type="date" id="desde_${persona}" value="${desde}"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #374151;">
                                        Hasta:
                                    </label>
                                    <input type="date" id="hasta_${persona}" value="${hasta}"
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #374151;">
                                    Motivo:
                                </label>
                                <input type="text" id="motivo_${persona}" value="${motivo}" 
                                       placeholder="Ej: Vacaciones, Licencia m√©dica, etc."
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                            </div>
                            
                            <button onclick="guardarInactividad('${persona}')" 
                                    style="margin-top: 12px; width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                üíæ Guardar Per√≠odo de Inactividad
                            </button>
                        </div>
                        
                        ${!activo && (desde || hasta) ? `
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; font-size: 0.85rem; border-left: 3px solid #f59e0b;">
                                <strong>üìå Resumen:</strong><br>
                                ${desde ? `Desde: ${formatearFecha(desde)}<br>` : ''}
                                ${hasta ? `Hasta: ${formatearFecha(hasta)}<br>` : ''}
                                ${motivo ? `Motivo: ${motivo}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                lista.appendChild(div);
                
                // Event listener para mostrar/ocultar panel
                const checkbox = document.getElementById(`check_${persona}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const panel = document.getElementById(`panel_${persona}`);
                        if (panel) {
                            panel.style.display = this.checked ? 'none' : 'block';
                        }
                    });
                }
            });
            
            document.getElementById('modalPersonas').classList.add('active');
        }

        // Formatear fecha para mostrar
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr + 'T00:00:00');
            return fecha.toLocaleDateString('es-AR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Guardar per√≠odo de inactividad
        async function guardarInactividad(persona) {
            const desde = document.getElementById(`desde_${persona}`).value;
            const hasta = document.getElementById(`hasta_${persona}`).value;
            const motivo = document.getElementById(`motivo_${persona}`).value;
            
            if (!motivo) {
                mostrarAlerta('Debes ingresar un motivo de inactividad', 'warning');
                return;
            }
            
            if (!desde && !hasta) {
                mostrarAlerta('Debes especificar al menos una fecha (desde o hasta)', 'warning');
                return;
            }
            
            // Validar que 'desde' sea anterior a 'hasta'
            if (desde && hasta && desde > hasta) {
                mostrarAlerta('La fecha "Desde" debe ser anterior a la fecha "Hasta"', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/disponibilidad/${encodeURIComponent(persona)}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        activo: false,
                        motivo: motivo,
                        desde: desde || null,
                        hasta: hasta || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let mensaje = `‚úÖ ${data.mensaje}\n\n`;
                    mensaje += `üìÖ Per√≠odo: ${desde ? formatearFecha(desde) : 'Sin fecha inicio'} ‚Üí ${hasta ? formatearFecha(hasta) : 'Sin fecha fin'}\n`;
                    mensaje += `üìù Motivo: ${motivo}`;
                    
                    mostrarAlerta(data.mensaje, 'success');
                    alert(mensaje);
                    
                    await cargarPersonas();
                    await cargarDisponibilidad();
                    if (mesActual) {
                        await cargarMes(mesActual);
                    }
                    
                    // Recargar modal
                    cerrarModal('modalPersonas');
                    setTimeout(() => mostrarGestionPersonas(), 300);
                } else {
                    mostrarAlerta('Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al guardar per√≠odo de inactividad', 'error');
            }
        }

        // Toggle estado activo de persona (solo cambia visualmente)
        async function togglePersonaActivo(persona, activo) {
            if (activo) {
                // Si activa la persona, guardar inmediatamente como activa
                try {
                    const response = await fetch(`/api/disponibilidad/${encodeURIComponent(persona)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            activo: true,
                            motivo: null,
                            desde: null,
                            hasta: null
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        mostrarAlerta(`‚úÖ ${persona} marcado como ACTIVO`, 'success');
                        await cargarPersonas();
                        await cargarDisponibilidad();
                        if (mesActual) {
                            await cargarMes(mesActual);
                        }
                        
                        // Recargar modal
                        cerrarModal('modalPersonas');
                        setTimeout(() => mostrarGestionPersonas(), 300);
                    } else {
                        mostrarAlerta('Error: ' + data.error, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarAlerta('Error al actualizar disponibilidad', 'error');
                }
            }
            // Si desactiva, solo muestra el panel, el guardado lo hace el bot√≥n
        }

        // Descargar Excel
        function descargarExcel() {
            window.location.href = '/api/descargar';
        }

        // Cerrar modal
        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo) {
            const alert = document.getElementById('alertBox');
            alert.className = `alert alert-${tipo} show`;
            alert.textContent = mensaje;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Cargar selector de usuarios
        async function cargarSelectorUsuarios() {
            try {
                const response = await fetch('/api/disponibilidad');
                personasDisponibilidad = await response.json();
                
                const grid = document.getElementById('userSelectorGrid');
                grid.innerHTML = '';
                
                // Obtener primer d√≠a del mes actual para verificar disponibilidad
                let fechaReferencia = null;
                if (mesActual) {
                    const mesNum = {
                        'Enero': 1, 'Febrero': 2, 'Marzo': 3, 'Abril': 4,
                        'Mayo': 5, 'Junio': 6, 'Julio': 7, 'Agosto': 8,
                        'Septiembre': 9, 'Octubre': 10, 'Noviembre': 11, 'Diciembre': 12
                    }[mesActual];
                    fechaReferencia = `2026-${String(mesNum).padStart(2, '0')}-15`; // D√≠a 15 como referencia
                }
                
                for (const persona in personasDisponibilidad) {
                    const info = personasDisponibilidad[persona];
                    
                    // Verificar disponibilidad espec√≠fica para este mes
                    let disponibleEnMes = true;
                    if (fechaReferencia) {
                        disponibleEnMes = await verificarDisponibilidadEnFecha(persona, fechaReferencia);
                    } else {
                        // Si no hay mes seleccionado, usar estado general
                        disponibleEnMes = info.activo;
                    }
                    
                    // Obtener estad√≠sticas del usuario
                    let stats = { total: 0, habil: 0, vispera: 0, feriado: 0 };
                    try {
                        const respStats = await fetch(`/api/estadisticas/usuario/${encodeURIComponent(persona)}`);
                        const dataStats = await respStats.json();
                        if (dataStats.estadisticas) {
                            stats = dataStats.estadisticas;
                        }
                    } catch (e) {
                        console.error('Error cargando stats:', e);
                    }
                    
                    estadisticasUsuarios[persona] = stats;
                    
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    
                    // Marcar como inactivo solo si NO est√° disponible en ESTE mes
                    if (!disponibleEnMes) {
                        card.classList.add('inactive');
                    }
                    if (usuarioSeleccionado === persona) {
                        card.classList.add('selected');
                    }
                    
                    // Mostrar indicador de periodo de inactividad si aplica
                    let indicadorInactividad = '';
                    if (!info.activo && (info.desde || info.hasta)) {
                        const desde = info.desde ? new Date(info.desde).toLocaleDateString('es-AR', {month: 'short', day: 'numeric'}) : '...';
                        const hasta = info.hasta ? new Date(info.hasta).toLocaleDateString('es-AR', {month: 'short', day: 'numeric'}) : '...';
                        
                        if (!disponibleEnMes) {
                            indicadorInactividad = `<div style="font-size: 0.7rem; color: #dc2626; margin-top: 3px;">üö´ ${desde} - ${hasta}</div>`;
                        }
                    }
                    
                    card.innerHTML = `
                        <div>
                            <div class="user-card-name">${persona}</div>
                            <div class="user-card-stats">
                                <span class="stat-badge" title="H√°biles">H: ${stats.habil}</span>
                                <span class="stat-badge" title="V√≠speras">V: ${stats.vispera}</span>
                                <span class="stat-badge" title="Feriados">F: ${stats.feriado}</span>
                            </div>
                            ${indicadorInactividad}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${stats.total}</div>
                    `;
                    
                    if (disponibleEnMes) {
                        card.onclick = () => seleccionarUsuario(persona);
                    }
                    
                    grid.appendChild(card);
                }
            } catch (error) {
                console.error('Error cargando selector:', error);
            }
        }

        // Verificar disponibilidad en fecha espec√≠fica
        async function verificarDisponibilidadEnFecha(persona, fecha) {
            try {
                const response = await fetch(`/api/personas/activas?fecha=${fecha}`);
                const data = await response.json();
                
                // El API devuelve {personas: [{nombre: "...", activo: true}, ...]}
                const personaEnLista = data.personas.find(p => p.nombre === persona);
                return personaEnLista !== undefined;
            } catch (error) {
                console.error('Error verificando disponibilidad:', error);
                // En caso de error, usar estado general
                return personasDisponibilidad[persona]?.activo || false;
            }
        }

        // Seleccionar usuario
        function seleccionarUsuario(persona) {
            usuarioSeleccionado = persona;
            
            // Actualizar UI
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Cargar estad√≠sticas
            cargarEstadisticasUsuario(persona);
        }

        // Cargar estad√≠sticas de usuario
        async function cargarEstadisticasUsuario(persona) {
            try {
                const response = await fetch(`/api/estadisticas/usuario/${encodeURIComponent(persona)}`);
                const data = await response.json();
                
                const stats = data.estadisticas;
                
                document.getElementById('statsUserName').textContent = persona;
                document.getElementById('statsTotal').textContent = stats.total;
                document.getElementById('statsHabil').textContent = stats.habil;
                document.getElementById('statsVispera').textContent = stats.vispera;
                document.getElementById('statsFeriado').textContent = stats.feriado;
                
                // Estad√≠sticas del mes actual
                const statsMes = stats.por_mes && stats.por_mes[mesActual] ? stats.por_mes[mesActual].total : 0;
                document.getElementById('statsMesActual').textContent = statsMes;
                
                document.getElementById('userStats').classList.add('show');
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Activar modo auto-asignaci√≥n
        // Distribuci√≥n autom√°tica
        async function distribucionAutomatica() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            const confirmar = confirm(
                `üéØ DISTRIBUCI√ìN COMPLETA Y EQUITATIVA - ${mesActual}\n\n` +
                `‚ö†Ô∏è ATENCI√ìN: Esto LLENAR√Å TODOS los d√≠as del mes\n` +
                `(Sobrescribir√° asignaciones existentes)\n\n` +
                `üìä SISTEMA DE PUNTOS:\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `‚Ä¢ D√≠a h√°bil    = 1.0 punto  (m√°s liviano)\n` +
                `‚Ä¢ V√≠spera      = 1.5 puntos (intermedio)\n` +
                `‚Ä¢ Feriado      = 2.0 puntos (m√°s pesado)\n\n` +
                `‚úÖ GARANT√çAS:\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `1. TODO el mes queda cubierto (100%)\n` +
                `2. Cada persona recibe puntos similares\n` +
                `3. Balance autom√°tico entre tipos de d√≠a\n\n` +
                `Ejemplo: Persona con 2 feriados (4 pts) es similar\n` +
                `a otra con 1 feriado + 1 v√≠spera + 1 h√°bil (4.5 pts)\n\n` +
                `‚ö†Ô∏è Esto reemplazar√° asignaciones existentes.\n\n` +
                `¬øContinuar?`
            );
            
            if (!confirmar) return;
            
            try {
                mostrarAlerta('‚è≥ Calculando distribuci√≥n equitativa completa...', 'info');
                
                const response = await fetch(`/api/distribucion/auto/${mesActual}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Crear mensaje detallado
                    let mensaje = `‚úÖ DISTRIBUCI√ìN COMPLETA - ${data.mes}\n`;
                    mensaje += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                    mensaje += `üìä RESUMEN:\n`;
                    mensaje += `‚Ä¢ Cobertura: ${data.cobertura}\n`;
                    mensaje += `‚Ä¢ D√≠as asignados: ${data.dias_asignados} de ${data.dias_totales}\n`;
                    mensaje += `‚Ä¢ Personas: ${data.personas_participantes}\n\n`;
                    
                    mensaje += `üíØ SISTEMA DE PUNTOS:\n`;
                    mensaje += `‚Ä¢ H√°bil: ${data.sistema_puntos.habil}\n`;
                    mensaje += `‚Ä¢ V√≠spera: ${data.sistema_puntos.vispera}\n`;
                    mensaje += `‚Ä¢ Feriado: ${data.sistema_puntos.feriado}\n\n`;
                    
                    mensaje += `üéØ EQUIDAD:\n`;
                    mensaje += `‚Ä¢ Puntos totales del mes: ${data.puntos_totales_mes}\n`;
                    mensaje += `‚Ä¢ Ideal por persona: ${data.puntos_ideal_por_persona}\n`;
                    mensaje += `‚Ä¢ M√≠nimo recibido: ${data.equidad.puntos_minimos} pts\n`;
                    mensaje += `‚Ä¢ M√°ximo recibido: ${data.equidad.puntos_maximos} pts\n`;
                    mensaje += `‚Ä¢ Diferencia: ${data.equidad.diferencia} pts\n`;
                    mensaje += `‚Ä¢ Nivel de equidad: ${data.equidad.nivel.toUpperCase()}\n\n`;
                    
                    mensaje += `üë• DISTRIBUCI√ìN POR PERSONA:\n`;
                    mensaje += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    // Ordenar por puntos para ver la distribuci√≥n
                    const personas_ordenadas = Object.entries(data.distribucion)
                        .sort((a, b) => b[1].puntos - a[1].puntos);
                    
                    for (const [persona, dist] of personas_ordenadas) {
                        mensaje += `\n${persona}:\n`;
                        mensaje += `  D√≠as: ${dist.total} (H:${dist.habil} V:${dist.vispera} F:${dist.feriado})\n`;
                        mensaje += `  Puntos: ${dist.puntos}\n`;
                    }
                    
                    mostrarAlerta(data.mensaje, 'success');
                    alert(mensaje);
                    
                    await cargarMes(mesActual);  // Recargar mes
                    await cargarSelectorUsuarios();  // Actualizar estad√≠sticas
                } else {
                    mostrarAlerta(data.error || 'Error en distribuci√≥n autom√°tica', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al realizar distribuci√≥n autom√°tica: ' + error.message, 'error');
            }
        }

        // Distribuci√≥n balanceada (actualiza tarjetas con sugerencias)
        async function distribucionBalanceada() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            try {
                mostrarAlerta('‚öñÔ∏è Calculando distribuci√≥n sugerida...', 'info');
                
                const response = await fetch(`/api/distribucion/balancear/${mesActual}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ solo_calcular: true })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Actualizar las tarjetas de usuarios con la distribuci√≥n sugerida
                    actualizarTarjetasConSugerencias(data.estado_final);
                    
                    // Mensaje corto de confirmaci√≥n
                    mostrarAlerta(
                        `‚úÖ Distribuci√≥n calculada: ${data.dias_pendientes_asignados} d√≠as pendientes entre ${data.personas_participantes} personas (${data.equidad.nivel})`, 
                        'success'
                    );
                } else {
                    mostrarAlerta(data.error || 'Error al calcular distribuci√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al calcular distribuci√≥n: ' + error.message, 'error');
            }
        }

        // Actualizar tarjetas de usuarios con sugerencias
        function actualizarTarjetasConSugerencias(estado_final) {
            const userCards = document.querySelectorAll('.user-card');
            
            // Primero limpiar todos los bordes y badges anteriores
            userCards.forEach(card => {
                const badgeAnterior = card.querySelector('.sugerencia-badge');
                if (badgeAnterior) {
                    badgeAnterior.remove();
                }
                card.style.border = '2px solid var(--color-border)'; // Resetear borde
            });
            
            userCards.forEach(card => {
                const personaName = card.querySelector('.user-card-name').textContent.trim();
                const sugerencia = estado_final[personaName];
                
                if (sugerencia) {
                    // Esta persona est√° en la distribuci√≥n sugerida
                    const estadisticas = estadisticasUsuarios[personaName] || { total: 0 };
                    
                    // Calcular cu√°ntas le faltan (basado en el total PROYECTADO vs actual)
                    const faltan = Math.max(0, sugerencia.total - estadisticas.total);
                    
                    // Crear badge con la sugerencia
                    const badge = document.createElement('div');
                    badge.className = 'sugerencia-badge';
                    
                    if (faltan > 0) {
                        // Necesita m√°s d√≠as
                        badge.innerHTML = `üìã Sugerido: +${faltan} d√≠a${faltan > 1 ? 's' : ''} (H:${sugerencia.habil} V:${sugerencia.vispera} F:${sugerencia.feriado})`;
                        card.style.border = '3px solid #f59e0b'; // Naranja
                    } else {
                        // Ya tiene la cuota completa o m√°s
                        badge.className = 'sugerencia-badge sugerencia-ok';
                        badge.innerHTML = `‚úÖ Guardia completa (${sugerencia.total} d√≠as)`;
                        card.style.border = '3px solid #10b981'; // Verde
                    }
                    
                    // Insertar despu√©s del nombre
                    const nameDiv = card.querySelector('.user-card-name');
                    nameDiv.parentNode.insertBefore(badge, nameDiv.nextSibling);
                } else {
                    // Persona no est√° en la distribuci√≥n (puede estar inactiva en este mes)
                    // Dejar sin badge ni borde especial
                }
            });
        }

        // Calcular cuotas sugeridas (SIN asignar autom√°ticamente)
        async function calcularCuotas() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            try {
                mostrarAlerta('üßÆ Calculando cuotas sugeridas...', 'info');
                
                const response = await fetch(`/api/cuotas/sugeridas/${mesActual}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Actualizar las tarjetas de usuario con las cuotas
                    await mostrarCuotasSugeridas(data);
                    
                    let mensaje = `üéØ CUOTAS SUGERIDAS - ${data.mes}\n\n`;
                    mensaje += `üìä RESUMEN:\n`;
                    mensaje += `‚Ä¢ Total d√≠as del mes: ${data.total_dias_mes}\n`;
                    mensaje += `‚Ä¢ Ya asignados: ${data.dias_asignados}\n`;
                    mensaje += `‚Ä¢ Disponibles: ${data.dias_disponibles}\n`;
                    mensaje += `  - H√°biles: ${data.disponibles_por_tipo.habil}\n`;
                    mensaje += `  - V√≠speras: ${data.disponibles_por_tipo.vispera}\n`;
                    mensaje += `  - Feriados: ${data.disponibles_por_tipo.feriado}\n\n`;
                    
                    mensaje += `üíØ IDEAL POR PERSONA:\n`;
                    mensaje += `‚Ä¢ D√≠as totales: ${data.cuota_ideal_por_persona}\n`;
                    mensaje += `‚Ä¢ Puntos: ${data.puntos_ideal_por_persona}\n\n`;
                    
                    mensaje += `üë• CUOTAS INDIVIDUALES:\n`;
                    mensaje += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    for (const persona in data.cuotas_sugeridas) {
                        const cuota = data.cuotas_sugeridas[persona];
                        const actual = cuota.actuales;
                        
                        mensaje += `\n${persona}:\n`;
                        mensaje += `  Tiene: ${actual.total} d√≠as (H:${actual.habil} V:${actual.vispera} F:${actual.feriado})\n`;
                        mensaje += `  Puntos: ${actual.puntos.toFixed(1)} / ${cuota.puntos_ideal}\n`;
                        
                        if (cuota.balance === 'OK') {
                            mensaje += `  ‚úÖ COMPLETO\n`;
                        } else if (cuota.balance === 'NECESITA_MAS') {
                            mensaje += `  ‚è≥ Le faltan ~${cuota.faltan_dias} d√≠as m√°s\n`;
                        } else {
                            mensaje += `  ‚úîÔ∏è Tiene suficiente\n`;
                        }
                    }
                    
                    mensaje += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    mensaje += `üí° Usa el modo auto-asignaci√≥n para que cada\n`;
                    mensaje += `   persona tome sus d√≠as faltantes.\n`;
                    
                    alert(mensaje);
                    mostrarAlerta('‚úÖ Cuotas calculadas - Revisa las tarjetas de usuarios', 'success');
                } else {
                    mostrarAlerta(data.error || 'Error al calcular cuotas', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al calcular cuotas: ' + error.message, 'error');
            }
        }

        // Mostrar cuotas sugeridas en las tarjetas de usuario
        async function mostrarCuotasSugeridas(data) {
            // Recargar selector con las cuotas actualizadas
            await cargarSelectorUsuarios();
            
            // Resaltar qui√©nes necesitan m√°s d√≠as
            for (const persona in data.cuotas_sugeridas) {
                const cuota = data.cuotas_sugeridas[persona];
                const cards = document.querySelectorAll('.user-card');
                
                cards.forEach(card => {
                    if (card.textContent.includes(persona)) {
                        if (cuota.balance === 'NECESITA_MAS') {
                            card.style.borderColor = '#f59e0b';
                            card.style.borderWidth = '3px';
                        } else if (cuota.balance === 'OK') {
                            card.style.borderColor = '#10b981';
                            card.style.borderWidth = '3px';
                        }
                    }
                });
            }
        }

        // Resetear mes completo
        async function resetearMes() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            // Confirmaci√≥n con advertencia fuerte
            const confirmar1 = confirm(
                `‚ö†Ô∏è ADVERTENCIA: RESETEAR ${mesActual.toUpperCase()}\n\n` +
                `Esto ELIMINAR√Å TODAS las asignaciones del mes:\n` +
                `‚Ä¢ Se borrar√°n todos los oficiales asignados\n` +
                `‚Ä¢ El mes quedar√° completamente vac√≠o\n` +
                `‚Ä¢ Esta acci√≥n NO se puede deshacer\n\n` +
                `Los dem√°s meses NO ser√°n afectados.\n\n` +
                `¬øEst√°s SEGURO que quieres continuar?`
            );
            
            if (!confirmar1) return;
            
            // Segunda confirmaci√≥n
            const confirmar2 = confirm(
                `üö® √öLTIMA CONFIRMACI√ìN\n\n` +
                `Escribe mentalmente "S√ç, BORRAR TODO" y confirma.\n\n` +
                `Se eliminar√°n TODAS las guardias de ${mesActual}.\n\n` +
                `¬øProceder?`
            );
            
            if (!confirmar2) return;
            
            try {
                mostrarAlerta('üóëÔ∏è Reseteando mes...', 'info');
                
                const response = await fetch(`/api/mes/${mesActual}/resetear`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let mensaje = `‚úÖ MES RESETEADO EXITOSAMENTE\n\n`;
                    mensaje += `üìÖ Mes: ${data.mes}\n`;
                    mensaje += `üóëÔ∏è Asignaciones eliminadas: ${data.asignaciones_eliminadas}\n`;
                    mensaje += `üë• Personas afectadas: ${data.personas_afectadas}\n\n`;
                    mensaje += `${data.detalle}\n\n`;
                    mensaje += `El mes ahora est√° completamente vac√≠o.\n`;
                    mensaje += `Puedes empezar a asignar de cero.`;
                    
                    alert(mensaje);
                    mostrarAlerta(data.mensaje, 'success');
                    
                    // Recargar el mes
                    await cargarMes(mesActual);
                    
                    // Actualizar selector de usuarios (sus conteos cambiaron)
                    await cargarSelectorUsuarios();
                } else {
                    mostrarAlerta('Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al resetear el mes: ' + error.message, 'error');
            }
        }

        // Mostrar c√≥mputo mensual
        async function mostrarComputoMensual() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/mes/${mesActual}`);
                const data = await response.json();
                
                document.getElementById('computoMesNombre').textContent = mesActual + ' 2026';
                
                const dias = data.dias;
                const estadisticas = data.estadisticas;
                
                // Calcular estad√≠sticas por persona
                const computo = {};
                
                for (const dia in dias) {
                    const info = dias[dia];
                    const persona = info.persona;
                    
                    if (persona) {
                        if (!computo[persona]) {
                            computo[persona] = {
                                habil: 0,
                                vispera: 0,
                                feriado: 0,
                                total: 0,
                                puntos: 0
                            };
                        }
                        
                        computo[persona][info.tipo]++;
                        computo[persona].total++;
                        
                        // Calcular puntos
                        const puntosPorTipo = {
                            'habil': 1.0,
                            'vispera': 1.5,
                            'feriado': 2.0
                        };
                        computo[persona].puntos += puntosPorTipo[info.tipo];
                    }
                }
                
                // Ordenar por total descendente
                const personasOrdenadas = Object.entries(computo).sort((a, b) => b[1].total - a[1].total);
                
                // Calcular totales
                const totales = {
                    habil: 0,
                    vispera: 0,
                    feriado: 0,
                    total: 0,
                    puntos: 0
                };
                
                for (const [_, datos] of personasOrdenadas) {
                    totales.habil += datos.habil;
                    totales.vispera += datos.vispera;
                    totales.feriado += datos.feriado;
                    totales.total += datos.total;
                    totales.puntos += datos.puntos;
                }
                
                // Generar HTML
                let html = `
                    <div class="computo-summary">
                        <div class="summary-card">
                            <h4>Total D√≠as</h4>
                            <div class="value">${estadisticas.total}</div>
                            <div class="subtitle">en el mes</div>
                        </div>
                        <div class="summary-card">
                            <h4>Asignados</h4>
                            <div class="value" style="color: var(--color-success);">${estadisticas.asignados}</div>
                            <div class="subtitle">${Math.round(estadisticas.asignados/estadisticas.total*100)}% cobertura</div>
                        </div>
                        <div class="summary-card">
                            <h4>Pendientes</h4>
                            <div class="value" style="color: var(--color-danger);">${estadisticas.pendientes}</div>
                            <div class="subtitle">sin asignar</div>
                        </div>
                        <div class="summary-card">
                            <h4>Puntos Totales</h4>
                            <div class="value" style="color: var(--color-primary);">${totales.puntos.toFixed(1)}</div>
                            <div class="subtitle">sistema de puntos</div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: var(--color-dark);">üìã Detalle por Persona</h4>
                    
                    <table class="computo-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Persona</th>
                                <th class="text-center">H√°biles</th>
                                <th class="text-center">V√≠speras</th>
                                <th class="text-center">Feriados</th>
                                <th class="text-center">Total D√≠as</th>
                                <th class="text-center">Puntos</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let posicion = 1;
                for (const [persona, datos] of personasOrdenadas) {
                    const rankClass = posicion <= 3 ? `ranking-${posicion}` : '';
                    
                    html += `
                        <tr>
                            <td class="text-center">
                                <span class="ranking-position ${rankClass}">${posicion}</span>
                            </td>
                            <td><strong>${persona}</strong></td>
                            <td class="text-center">
                                <span class="computo-badge badge-habil">${datos.habil}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-vispera">${datos.vispera}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-feriado">${datos.feriado}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-total">${datos.total}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-puntos">${datos.puntos.toFixed(1)}</span>
                            </td>
                        </tr>
                    `;
                    posicion++;
                }
                
                html += `
                        <tr class="total-row">
                            <td colspan="2" class="text-right"><strong>TOTALES:</strong></td>
                            <td class="text-center"><strong>${totales.habil}</strong></td>
                            <td class="text-center"><strong>${totales.vispera}</strong></td>
                            <td class="text-center"><strong>${totales.feriado}</strong></td>
                            <td class="text-center"><strong>${totales.total}</strong></td>
                            <td class="text-center"><strong>${totales.puntos.toFixed(1)}</strong></td>
                        </tr>
                    </tbody>
                    </table>
                `;
                
                document.getElementById('computoMensualContent').innerHTML = html;
                document.getElementById('modalComputoMensual').classList.add('active');
                
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al generar c√≥mputo mensual', 'error');
            }
        }

        // Mostrar c√≥mputo anual
        async function mostrarComputoAnual() {
            try {
                mostrarAlerta('‚è≥ Cargando c√≥mputo anual...', 'info');
                
                const response = await fetch('/api/reporte/anual');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('Datos recibidos:', data);
                
                // Calcular estad√≠sticas por persona en todo el a√±o
                const computoAnual = {};
                
                // Inicializar con datos del API
                for (const persona in data.por_persona) {
                    computoAnual[persona] = {
                        habil: 0,
                        vispera: 0,
                        feriado: 0,
                        total: data.por_persona[persona].total,
                        puntos: 0,
                        por_mes: data.por_persona[persona].por_mes
                    };
                }
                
                // Obtener detalles de cada mes para calcular tipos y puntos
                const PUNTOS = {'habil': 1.0, 'vispera': 1.5, 'feriado': 2.0};
                
                for (const mes in data.meses) {
                    try {
                        const respMes = await fetch(`/api/mes/${mes}`);
                        if (!respMes.ok) continue;
                        
                        const dataMes = await respMes.json();
                        
                        for (const dia in dataMes.dias) {
                            const info = dataMes.dias[dia];
                            const persona = info.persona;
                            
                            if (persona && computoAnual[persona]) {
                                const tipo = info.tipo;
                                computoAnual[persona][tipo]++;
                                computoAnual[persona].puntos += PUNTOS[tipo];
                            }
                        }
                    } catch (error) {
                        console.error(`Error cargando ${mes}:`, error);
                    }
                }
                
                // Ordenar por total
                const personasOrdenadas = Object.entries(computoAnual).sort((a, b) => b[1].total - a[1].total);
                
                // Calcular totales generales
                const totales = {
                    habil: 0,
                    vispera: 0,
                    feriado: 0,
                    total: data.totales.dias_asignados,
                    puntos: 0
                };
                
                for (const [_, datos] of personasOrdenadas) {
                    totales.habil += datos.habil;
                    totales.vispera += datos.vispera;
                    totales.feriado += datos.feriado;
                    totales.puntos += datos.puntos;
                }
                
                const promedio = personasOrdenadas.length > 0 ? totales.total / personasOrdenadas.length : 0;
                
                // Generar HTML
                let html = `
                    <div class="computo-summary">
                        <div class="summary-card">
                            <h4>Total D√≠as A√±o</h4>
                            <div class="value">${data.totales.dias_totales}</div>
                            <div class="subtitle">en 2026</div>
                        </div>
                        <div class="summary-card">
                            <h4>D√≠as Asignados</h4>
                            <div class="value" style="color: var(--color-success);">${data.totales.dias_asignados}</div>
                            <div class="subtitle">${data.totales.porcentaje_cobertura}% del a√±o</div>
                        </div>
                        <div class="summary-card">
                            <h4>Promedio por Persona</h4>
                            <div class="value" style="color: var(--color-primary);">${promedio.toFixed(1)}</div>
                            <div class="subtitle">d√≠as/persona</div>
                        </div>
                        <div class="summary-card">
                            <h4>Puntos Totales</h4>
                            <div class="value" style="color: var(--color-warning);">${totales.puntos.toFixed(1)}</div>
                            <div class="subtitle">sistema equitativo</div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: var(--color-dark);">üìä Ranking Anual 2026</h4>
                    
                    <table class="computo-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Persona</th>
                                <th class="text-center">H√°biles</th>
                                <th class="text-center">V√≠speras</th>
                                <th class="text-center">Feriados</th>
                                <th class="text-center">Total D√≠as</th>
                                <th class="text-center">Puntos</th>
                                <th class="text-center">vs Promedio</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let posicion = 1;
                for (const [persona, datos] of personasOrdenadas) {
                    const rankClass = posicion <= 3 ? `ranking-${posicion}` : '';
                    const diferencia = datos.total - promedio;
                    const diferenciaColor = diferencia > 0 ? '#dc2626' : diferencia < 0 ? '#16a34a' : '#6b7280';
                    const diferenciaTexto = diferencia > 0 ? `+${diferencia.toFixed(1)}` : diferencia.toFixed(1);
                    
                    html += `
                        <tr>
                            <td class="text-center">
                                <span class="ranking-position ${rankClass}">${posicion}</span>
                            </td>
                            <td><strong>${persona}</strong></td>
                            <td class="text-center">
                                <span class="computo-badge badge-habil">${datos.habil}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-vispera">${datos.vispera}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-feriado">${datos.feriado}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-total">${datos.total}</span>
                            </td>
                            <td class="text-center">
                                <span class="computo-badge badge-puntos">${datos.puntos.toFixed(1)}</span>
                            </td>
                            <td class="text-center">
                                <span style="color: ${diferenciaColor}; font-weight: 600;">${diferenciaTexto}</span>
                            </td>
                        </tr>
                    `;
                    posicion++;
                }
                
                html += `
                        <tr class="total-row">
                            <td colspan="2" class="text-right"><strong>TOTALES:</strong></td>
                            <td class="text-center"><strong>${totales.habil}</strong></td>
                            <td class="text-center"><strong>${totales.vispera}</strong></td>
                            <td class="text-center"><strong>${totales.feriado}</strong></td>
                            <td class="text-center"><strong>${totales.total}</strong></td>
                            <td class="text-center"><strong>${totales.puntos.toFixed(1)}</strong></td>
                            <td class="text-center">-</td>
                        </tr>
                    </tbody>
                    </table>
                    
                    <h4 style="margin: 30px 0 15px 0; color: var(--color-dark);">üìÖ Distribuci√≥n por Mes</h4>
                    
                    <div class="mes-grid">
                `;
                
                for (const mes in data.meses) {
                    html += `
                        <div class="mes-card">
                            <h5>${mes}</h5>
                            <div class="dias">${data.meses[mes].asignados}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                de ${data.meses[mes].total}
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                document.getElementById('computoAnualContent').innerHTML = html;
                document.getElementById('modalComputoAnual').classList.add('active');
                
                mostrarAlerta('‚úÖ C√≥mputo anual cargado', 'success');
                
            } catch (error) {
                console.error('Error completo:', error);
                mostrarAlerta('Error al generar c√≥mputo anual: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // FUNCIONES DEL SLIDER DE CUOTAS
        // ============================================================================
        
        // Sobrescribir calcularCuotas original para usar slider
        const calcularCuotasOriginal = calcularCuotas;
        calcularCuotas = async function() {
            if (!mesActual) {
                mostrarAlerta('Primero selecciona un mes', 'warning');
                return;
            }
            
            try {
                mostrarAlerta('üßÆ Calculando cuotas sugeridas...', 'info');
                
                const response = await fetch(`/api/cuotas/sugeridas/${mesActual}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Actualizar las tarjetas de usuario con las cuotas
                    await mostrarCuotasSugeridas(data);
                    
                    // Abrir slider en lugar de alert
                    abrirSliderCuotas(data);
                    
                    mostrarAlerta('‚úÖ Cuotas calculadas', 'success');
                } else {
                    mostrarAlerta(data.error || 'Error al calcular cuotas', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al calcular cuotas: ' + error.message, 'error');
            }
        };

        // Abrir slider de cuotas
        function abrirSliderCuotas(data) {
            const slider = document.getElementById('cuotasSlider');
            const overlay = document.getElementById('cuotasSliderOverlay');
            
            // Actualizar nombre del mes
            document.getElementById('cuotasMesNombre').textContent = data.mes;
            
            // Generar resumen
            const resumenHTML = `
                <h4>üìä Resumen del Mes</h4>
                <div class="cuotas-resumen-item">
                    <span>Total d√≠as:</span>
                    <span>${data.total_dias_mes}</span>
                </div>
                <div class="cuotas-resumen-item">
                    <span>Ya asignados:</span>
                    <span>${data.dias_asignados}</span>
                </div>
                <div class="cuotas-resumen-item">
                    <span>Disponibles:</span>
                    <span>${data.dias_disponibles}</span>
                </div>
                <div class="cuotas-resumen-item">
                    <span style="font-size: 0.8rem;">H / V / F disponibles:</span>
                    <span>${data.disponibles_por_tipo.habil} / ${data.disponibles_por_tipo.vispera} / ${data.disponibles_por_tipo.feriado}</span>
                </div>
                <div class="cuotas-resumen-item">
                    <span>Cuota ideal/persona:</span>
                    <span>${data.cuota_ideal_por_persona} d√≠as</span>
                </div>
                <div class="cuotas-resumen-item">
                    <span>Puntos ideal/persona:</span>
                    <span>${data.puntos_ideal_por_persona}</span>
                </div>
            `;
            document.getElementById('cuotasResumen').innerHTML = resumenHTML;
            
            // Generar tarjetas de personas - ordenar por balance
            let personasHTML = '';
            const personasOrdenadas = Object.entries(data.cuotas_sugeridas).sort((a, b) => {
                if (a[1].es_dnrd) return -1;  // DNRD siempre primero
                if (b[1].es_dnrd) return 1;
                // Ordenar por orden de llenado (m√°s moderno primero = n√∫mero m√°s bajo)
                const ordenA = a[1].orden ?? 99;
                const ordenB = b[1].orden ?? 99;
                return ordenA - ordenB;
            });
            
            for (const [persona, cuota] of personasOrdenadas) {
                // ---- Tarjeta especial para DNRD ----
                if (cuota.es_dnrd) {
                    const sugerido = cuota.sugeridos;
                    const diasEsp = cuota.dias_especificos || [];
                    let listaDias = '';
                    if (diasEsp.length > 0) {
                        listaDias = diasEsp.map(d => {
                            const f = new Date(d.fecha + 'T00:00:00');
                            const opciones = { day: 'numeric', month: 'short', weekday: 'short' };
                            const etiqueta = d.tipo === 'feriado' ? 'üî¥' : d.tipo === 'vispera' ? 'üü°' : 'üîµ';
                            return `<li>${etiqueta} ${f.toLocaleDateString('es-AR', opciones)} (d√≠a ${d.dia})</li>`;
                        }).join('');
                    }
                    personasHTML += `
                        <div class="cuota-persona-card" style="border: 2.5px solid #b45309; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); grid-column: 1 / -1;">
                            <div class="cuota-persona-nombre" style="color: #b45309;">‚ö†Ô∏è DNRD ‚Äî D√≠as sin personal disponible</div>
                            <div style="font-size: 0.9em; color: #92400e; margin: 6px 0 4px;">
                                Estos d√≠as <strong>todos los oficiales est√°n de campa√±a</strong>. Deben ser cubiertos por <strong>DNRD</strong>.
                            </div>
                            <div class="cuota-persona-stats">
                                <div class="cuota-stat"><strong>D√≠as a cubrir:</strong> ${sugerido.total}</div>
                                <div class="cuota-stat">H:${sugerido.habil} V:${sugerido.vispera} F:${sugerido.feriado}</div>
                            </div>
                            ${listaDias ? `<ul style="margin: 8px 0 0 0; padding-left: 18px; font-size: 0.88em; color: #78350f;">${listaDias}</ul>` : ''}
                        </div>
                    `;
                    continue;
                }

                const actual = cuota.actuales;
                const sugerido = cuota.sugeridos;
                const proyectado = cuota.proyectado;
                const claseEstado = cuota.balance === 'NECESITA_MAS' ? 'necesita-mas' : cuota.balance === 'OK' ? 'completo' : '';
                
                let estadoBadge = '';
                let desglose = '';
                
                // SIEMPRE mostrar la distribuci√≥n proyectada
                if (sugerido.total > 0) {
                    // Tiene d√≠as sugeridos para asignar
                    estadoBadge = `<span class="cuota-estado necesita">‚úÖ Le tocan: ${sugerido.habil}H, ${sugerido.vispera}V, ${sugerido.feriado}F</span>`;
                    desglose = `
                        <div class="cuota-desglose">
                            <strong>üìã Distribuci√≥n sugerida:</strong><br>
                            ‚Ä¢ ${sugerido.habil} d√≠a${sugerido.habil !== 1 ? 's' : ''} h√°bil${sugerido.habil !== 1 ? 'es' : ''}<br>
                            ‚Ä¢ ${sugerido.vispera} v√≠spera${sugerido.vispera !== 1 ? 's' : ''}<br>
                            ‚Ä¢ ${sugerido.feriado} feriado${sugerido.feriado !== 1 ? 's' : ''}<br>
                            <em style="font-size: 0.85em; color: #64748b;">
                                (Proyectado final: ${proyectado.total} d√≠as con ${proyectado.puntos} pts)
                            </em>
                        </div>
                    `;
                } else if (actual.total > 0) {
                    // Ya tiene d√≠as y no necesita m√°s
                    estadoBadge = `<span class="cuota-estado ok">‚úÖ Proyectado: ${proyectado.total} d√≠as (${proyectado.habil}H, ${proyectado.vispera}V, ${proyectado.feriado}F)</span>`;
                } else {
                    // No tiene nada
                    estadoBadge = '<span class="cuota-estado ok">Sin asignaciones</span>';
                }
                
                personasHTML += `
                    <div class="cuota-persona-card ${claseEstado}">
                        <div class="cuota-persona-nombre">
                            <span style="font-size:0.8em; color:#6b7280; font-weight:600; margin-right:6px;">#${cuota.orden ?? '?'}</span>${persona}<span style="font-size:0.75em; color:#9ca3af; font-weight:400; margin-left:6px;">RINA ${cuota.rina ?? '-'}</span>
                        </div>
                        <div class="cuota-persona-stats">
                            <div class="cuota-stat">
                                <strong>Actual:</strong> ${actual.total} d√≠as
                            </div>
                            <div class="cuota-stat">
                                <strong>Puntos:</strong> ${actual.puntos} / ${cuota.puntos_ideal}
                            </div>
                            <div class="cuota-stat">
                                H:${actual.habil} V:${actual.vispera} F:${actual.feriado}
                            </div>
                        </div>
                        ${estadoBadge}
                        ${desglose}
                    </div>
                `;
            }
            
            document.getElementById('cuotasPersonas').innerHTML = personasHTML;
            
            // Mostrar slider y overlay
            slider.classList.add('active');
            overlay.classList.add('active');
        }

        // Cerrar slider de cuotas
        function cerrarSliderCuotas() {
            const slider = document.getElementById('cuotasSlider');
            const overlay = document.getElementById('cuotasSliderOverlay');
            slider.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Iniciar cuando cargue la p√°gina ‚Äî verificar sesi√≥n primero
        window.onload = async function() {
            const logueado = await verificarSesion();
            if (logueado) {
                await init();
            }
        };
    </script>
</body>
</html>
